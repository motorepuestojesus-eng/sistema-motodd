<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Tienda Pro - Inventario y Clientes</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h2, h3 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .form-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; background: #eee; padding: 15px; border-radius: 5px; }
        input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; flex: 1; min-width: 150px; }
        button { padding: 8px 15px; cursor: pointer; background-color: #28a745; color: white; border: none; border-radius: 4px; }
        button.view { background-color: #007bff; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f8f9fa; }
        
        #areaImpresion { display: none; }

        @media print {
            body * { visibility: hidden; }
            #areaImpresion, #areaImpresion * { visibility: visible; display: block !important; }
            #areaImpresion { position: absolute; left: 0; top: 0; width: 58mm; font-size: 12px; }
            button { display: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ“¦ Registro de Inventario</h2>
    <div class="form-group">
        <input type="text" id="modelo" placeholder="Modelo">
        <input type="text" id="marca" placeholder="Marca/Proveedor">
        <input type="number" id="precio" placeholder="Precio ($)">
        <button onclick="agregarProducto()">Guardar Producto</button>
    </div>

    <table id="tablaProductos">
        <thead>
            <tr>
                <th>Modelo (Marca)</th>
                <th>Precio</th>
                <th>CÃ³digo de Barras</th>
                <th>AcciÃ³n</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2>ðŸ‘¥ Clientes Recurrentes</h2>
    <table id="tablaClientes">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Datos de Contacto</th>
                <th>Historial</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div id="areaImpresion">
    <center>
        <strong>MI TIENDA</strong><br>
        Factura de Venta<br>
        -------------------------
    </center>
    <p id="ticketFecha"></p>
    <p id="ticketCliente"></p>
    <div id="ticketDetalle"></div>
    -------------------------<br>
    <strong>TOTAL: $<span id="ticketTotal"></span></strong><br>
    <center>Â¡Gracias por su compra!</center>
</div>

<script>
    // Cargar datos al iniciar
    let inventario = JSON.parse(localStorage.getItem('inventario')) || [];
    let clientes = JSON.parse(localStorage.getItem('clientes')) || [];

    function guardarYRefrescar() {
        localStorage.setItem('inventario', JSON.stringify(inventario));
        localStorage.setItem('clientes', JSON.stringify(clientes));
        renderizarTablas();
    }

    function agregarProducto() {
        const modelo = document.getElementById('modelo').value;
        const marca = document.getElementById('marca').value;
        const precio = document.getElementById('precio').value;
        const idUnico = Date.now().toString().slice(-8);

        if(!modelo || !precio) return alert("Complete los datos");

        inventario.push({ idUnico, modelo, marca, precio });
        guardarYRefrescar();
    }

    function realizarVenta(index) {
        const prod = inventario[index];
        const nombreCliente = prompt("Nombre del cliente (si ya existe, se actualizarÃ¡ su historial):");
        if(!nombreCliente) return;

        const infoContacto = prompt("TelÃ©fono o ID del cliente:");
        
        // Buscar o Crear Cliente
        let cliente = clientes.find(c => c.nombre.toLowerCase() === nombreCliente.toLowerCase());
        if(!cliente) {
            cliente = { nombre: nombreCliente, contacto: infoContacto, compras: [] };
            clientes.push(cliente);
        }
        
        const fecha = new Date().toLocaleString();
        cliente.compras.push(`${fecha}: ${prod.modelo} ($${prod.precio})`);

        // Preparar Ticket
        document.getElementById('ticketFecha').innerText = "Fecha: " + fecha;
        document.getElementById('ticketCliente').innerText = "Cliente: " + cliente.nombre;
        document.getElementById('ticketDetalle').innerText = `${prod.modelo} (${prod.marca}) - $${prod.precio}`;
        document.getElementById('ticketTotal').innerText = prod.precio;

        guardarYRefrescar();
        window.print();
    }

    function renderizarTablas() {
        // Render Inventario
        const tbodyInv = document.querySelector("#tablaProductos tbody");
        tbodyInv.innerHTML = "";
        inventario.forEach((prod, i) => {
            const fila = `<tr>
                <td>${prod.modelo} (${prod.marca})</td>
                <td>$${prod.precio}</td>
                <td><svg id="barcode${i}"></svg></td>
                <td><button onclick="realizarVenta(${i})">Vender/Imprimir</button></td>
            </tr>`;
            tbodyInv.innerHTML += fila;
            setTimeout(() => {
                JsBarcode(`#barcode${i}`, prod.idUnico, { format: "CODE128", width: 1.2, height: 30, displayValue: true });
            }, 0);
        });

        // Render Clientes
        const tbodyCli = document.querySelector("#tablaClientes tbody");
        tbodyCli.innerHTML = "";
        clientes.forEach(c => {
            tbodyCli.innerHTML += `<tr>
                <td>${c.nombre}</td>
                <td>${c.contacto}</td>
                <td style="font-size: 0.8em">${c.compras.slice(-3).join('<br>')}</td>
            </tr>`;
        });
    }

    renderizarTablas();
</script>

</body>
</html>

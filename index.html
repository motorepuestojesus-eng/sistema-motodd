<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Tienda Pro - Inventario y Clientes</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        h2, h3 { color: #2c3e50; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 30px; }
        .form-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 25px; background: #e9f7ef; padding: 20px; border-radius: 8px; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); }
        input[type="text"], input[type="number"] { padding: 10px; border: 1px solid #a8dadc; border-radius: 5px; flex: 1; min-width: 120px; font-size: 1em; }
        input[type="number"] { width: 80px; } /* Ajuste para campos num茅ricos */
        button { padding: 10px 20px; cursor: pointer; background-color: #28a745; color: white; border: none; border-radius: 5px; font-size: 1em; transition: background-color 0.3s ease; }
        button:hover { background-color: #218838; }
        button.print-barcode-btn { background-color: #007bff; margin-left: 5px; }
        button.print-barcode-btn:hover { background-color: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 25px; background: white; border-radius: 8px; overflow: hidden; }
        th, td { border: 1px solid #e0e0e0; padding: 12px; text-align: left; vertical-align: middle; }
        th { background-color: #f2f2f2; color: #555; font-weight: bold; }
        tbody tr:nth-child(odd) { background-color: #fdfdfd; }
        tbody tr:hover { background-color: #f5f5f5; }
        .barcode-svg-container { text-align: center; padding: 5px; background-color: #f9f9f9; border-radius: 3px; }
        .barcode-print-area { display: none; text-align: center; } /* Para imprimir solo el c贸digo de barras */
        
        #areaImpresion { display: none; } /* Ocultar por defecto para impresi贸n de factura */

        @media print {
            body * { visibility: hidden; }
            #areaImpresion, #areaImpresion * { visibility: visible; display: block !important; }
            #areaImpresion { 
                position: absolute; left: 0; top: 0; 
                width: 58mm; /* Ancho t铆pico de ticketera */
                font-size: 12px; 
                padding: 5mm; /* Espacio para el ticket */
                box-sizing: border-box;
            }
            .no-print { display: none !important; } /* Oculta elementos que no se deben imprimir en el ticket */
            .barcode-print-area { 
                visibility: visible; 
                display: block !important; 
                position: absolute; 
                left: 0; top: 0; 
                width: 100%; 
                text-align: center; 
                padding: 10px; 
            }
            .barcode-print-area svg { width: 100%; height: auto; } /* Ajuste para el tama帽o del c贸digo de barras */
        }
    </style>
</head>
<body>

<div class="container no-print">
    <h2> Gesti贸n de Inventario</h2>
    <div class="form-group">
        <input type="text" id="modelo" placeholder="Modelo/Descripci贸n" required>
        <input type="text" id="marca" placeholder="Marca/Proveedor" required>
        <input type="number" id="precio" placeholder="Precio ($)" step="0.01" required>
        <input type="number" id="unidades" placeholder="Unidades" min="1" required>
        <button onclick="agregarProducto()">Agregar Producto</button>
    </div>

    <h3>Productos en Stock</h3>
    <table id="tablaProductos">
        <thead>
            <tr>
                <th>Modelo (Marca)</th>
                <th>Precio</th>
                <th>Unidades</th>
                <th>C贸digo de Barras</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2> Clientes Recurrentes</h2>
    <table id="tablaClientes">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Contacto</th>
                <th>ltimas Compras</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div id="barcodePrintContainer" class="barcode-print-area">
    <svg id="individualBarcode"></svg>
    <p id="barcodeLabel"></p>
</div>

<div id="areaImpresion">
    <center>
        <strong>MI TIENDA PRO</strong><br>
        Factura de Venta<br>
        -------------------------
    </center>
    <p>Fecha: <span id="ticketFecha"></span></p>
    <p>Cliente: <span id="ticketCliente"></span></p>
    <div id="ticketDetalle"></div>
    -------------------------<br>
    <strong>TOTAL: $<span id="ticketTotal"></span></strong><br>
    <center>隆Gracias por su compra!</center>
</div>

<script>
    // Cargar datos al iniciar
    let inventario = JSON.parse(localStorage.getItem('inventario')) || [];
    let clientes = JSON.parse(localStorage.getItem('clientes')) || [];

    // Funci贸n para guardar en LocalStorage y renderizar las tablas
    function guardarYRefrescar() {
        localStorage.setItem('inventario', JSON.stringify(inventario));
        localStorage.setItem('clientes', JSON.stringify(clientes));
        renderizarTablas();
    }

    // Agrega un nuevo producto al inventario
    function agregarProducto() {
        const modelo = document.getElementById('modelo').value;
        const marca = document.getElementById('marca').value;
        const precio = parseFloat(document.getElementById('precio').value);
        const unidades = parseInt(document.getElementById('unidades').value);
        const idUnico = generarIdUnico(); // Genera un ID 煤nico para el c贸digo de barras

        if(!modelo || !marca || isNaN(precio) || isNaN(unidades) || unidades <= 0) {
            return alert("Por favor, complete todos los campos correctamente.");
        }

        inventario.push({ idUnico, modelo, marca, precio, unidades });
        limpiarFormularioProducto();
        guardarYRefrescar();
    }

    // Genera un ID 煤nico para el c贸digo de barras
    function generarIdUnico() {
        // Combina un timestamp con un n煤mero aleatorio para mayor unicidad
        return Date.now().toString() + Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    }

    // Limpia los campos del formulario de producto despu茅s de agregar
    function limpiarFormularioProducto() {
        document.getElementById('modelo').value = '';
        document.getElementById('marca').value = '';
        document.getElementById('precio').value = '';
        document.getElementById('unidades').value = '';
    }

    // Realiza una venta, actualiza stock y registra al cliente
    function realizarVenta(index) {
        if (inventario[index].unidades <= 0) {
            return alert("No hay unidades disponibles de este producto.");
        }

        const prod = inventario[index];
        const cantidadAVender = parseInt(prompt(`驴Cu谩ntas unidades de "${prod.modelo}" (${prod.marca}) desea vender? (Stock: ${prod.unidades})`, 1));

        if (isNaN(cantidadAVender) || cantidadAVender <= 0 || cantidadAVender > prod.unidades) {
            return alert("Cantidad de venta inv谩lida o excede el stock.");
        }

        const nombreCliente = prompt("Nombre del cliente (si ya existe, se actualizar谩 su historial):");
        if(!nombreCliente) return;

        const infoContacto = prompt("Tel茅fono o ID del cliente:");
        
        // Buscar o Crear Cliente
        let cliente = clientes.find(c => c.nombre.toLowerCase() === nombreCliente.toLowerCase());
        if(!cliente) {
            cliente = { nombre: nombreCliente, contacto: infoContacto, compras: [] };
            clientes.push(cliente);
        }
        
        const fecha = new Date().toLocaleString();
        const totalVenta = prod.precio * cantidadAVender;
        cliente.compras.push(`${fecha}: ${cantidadAVender}x ${prod.modelo} ($${totalVenta.toFixed(2)})`);

        // Actualizar stock
        inventario[index].unidades -= cantidadAVender;

        // Preparar Ticket
        document.getElementById('ticketFecha').innerText = fecha;
        document.getElementById('ticketCliente').innerText = cliente.nombre;
        document.getElementById('ticketDetalle').innerHTML = `
            ${cantidadAVender}x ${prod.modelo} (${prod.marca}) @ $${prod.precio.toFixed(2)} c/u<br>
            Subtotal: $${totalVenta.toFixed(2)}
        `;
        document.getElementById('ticketTotal').innerText = totalVenta.toFixed(2);

        guardarYRefrescar();
        window.print(); // Imprime la factura
    }

    // Imprime un c贸digo de barras individual
    function imprimirCodigoBarras(idProducto, modelo, marca) {
        document.querySelector('.container').classList.add('no-print'); // Oculta el resto de la interfaz
        const barcodeContainer = document.getElementById('barcodePrintContainer');
        barcodeContainer.style.display = 'block'; // Muestra el contenedor de impresi贸n del c贸digo de barras

        // Genera el c贸digo de barras en el contenedor temporal
        JsBarcode("#individualBarcode", idProducto, { 
            format: "CODE128", 
            width: 2, // M谩s ancho para mejor lectura
            height: 60, // M谩s alto
            displayValue: true 
        });
        document.getElementById('barcodeLabel').innerText = `${modelo} (${marca})`;

        window.print(); // Imprime

        // Volver a ocultar y mostrar la interfaz principal despu茅s de la impresi贸n
        setTimeout(() => {
            barcodeContainer.style.display = 'none';
            document.querySelector('.container').classList.remove('no-print');
        }, 500); // Peque帽o retraso para asegurar que la impresi贸n se activa
    }

    // Renderiza las tablas de inventario y clientes
    function renderizarTablas() {
        // Render Inventario
        const tbodyInv = document.querySelector("#tablaProductos tbody");
        tbodyInv.innerHTML = "";
        inventario.forEach((prod, i) => {
            const fila = `<tr>
                <td>${prod.modelo} (${prod.marca})</td>
                <td>$${prod.precio.toFixed(2)}</td>
                <td>${prod.unidades}</td>
                <td class="barcode-svg-container"><svg id="barcodeInv${i}"></svg></td>
                <td>
                    <button onclick="realizarVenta(${i})">Vender</button>
                    <button class="print-barcode-btn" onclick="imprimirCodigoBarras('${prod.idUnico}', '${prod.modelo}', '${prod.marca}')">Imprimir CB</button>
                </td>
            </tr>`;
            tbodyInv.innerHTML += fila;
            // Generar el c贸digo de barras despu茅s de que el elemento SVG est茅 en el DOM
            setTimeout(() => {
                JsBarcode(`#barcodeInv${i}`, prod.idUnico, { 
                    format: "CODE128", 
                    width: 1.2, 
                    height: 30, 
                    displayValue: false // No mostrar el n煤mero debajo para la tabla
                });
            }, 0);
        });

        // Render Clientes
        const tbodyCli = document.querySelector("#tablaClientes tbody");
        tbodyCli.innerHTML = "";
        clientes.forEach(c => {
            tbodyCli.innerHTML += `<tr>
                <td>${c.nombre}</td>
                <td>${c.contacto || 'N/A'}</td>
                <td style="font-size: 0.8em">${c.compras.slice(-3).join('<br>')}</td>
            </tr>`;
        });
    }

    // Inicializa las tablas al cargar la p谩gina
    renderizarTablas();
</script>

</body>
</html>

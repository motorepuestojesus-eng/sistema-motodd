<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MotoPro Ultra - Sistema de Inventario Masivo</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        :root { --p: #004d40; --s: #00796b; --a: #ffc107; --d: #c62828; }
        body { font-family: 'Segoe UI', Arial; background: #f0f2f5; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* Panel Superior: Divisas y Config */
        .top-bar { background: var(--p); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .tasa-box { background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 5px; border: 1px solid var(--a); }

        .main-container { flex: 1; display: flex; padding: 15px; gap: 15px; overflow: hidden; }
        
        /* Secciones */
        .panel { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .panel-inv { flex: 3; } /* M√°s espacio al inventario */
        .panel-cli { flex: 1.5; }

        .scroll { overflow-y: auto; flex: 1; padding: 10px; }
        h3 { margin: 10px; color: var(--p); border-bottom: 2px solid #eee; }

        /* Estilos de Tabla */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { position: sticky; top: 0; background: var(--s); color: white; padding: 10px; z-index: 10; }
        td { padding: 8px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f1f8e9; }

        /* Inputs */
        .form-group { padding: 15px; background: #fafafa; border-bottom: 1px solid #eee; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .full-w { grid-column: span 2; }
        button { cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        .btn-add { background: var(--p); color: white; padding: 10px; }
        
        /* Impresi√≥n */
        @media print {
            body * { visibility: hidden; }
            #ticketPrint, #ticketPrint * { visibility: visible; display: block !important; position: absolute; left: 0; top: 0; width: 58mm; }
        }
    </style>
</head>
<body>

<div class="top-bar">
    <span>üèçÔ∏è MOTO PRO ULTRA (100k+ Capacidad)</span>
    <div class="tasa-box">
        TASA BCV: <input type="number" id="tasa" value="36.50" step="0.01" onchange="render()" style="width: 70px; background: none; border: none; color: var(--a); font-weight: bold; font-size: 16px;"> Bs/$
    </div>
</div>

<div class="main-container">
    <div class="panel panel-inv">
        <h3>üì¶ Inventario y Carga</h3>
        <div class="form-group">
            <input type="text" id="p_marca" placeholder="Marca">
            <input type="text" id="p_modelo" placeholder="Repuesto / Modelo">
            <input type="number" id="p_precio" placeholder="Precio ($)">
            <input type="number" id="p_stock" placeholder="Cantidad">
            <button class="btn-add full-w" onclick="agregarProducto()">REGISTRAR EN SISTEMA</button>
        </div>
        <input type="text" id="buscador" placeholder="üîç Buscar por nombre, marca o c√≥digo..." onkeyup="render()" style="margin: 10px; padding: 10px; border-radius: 20px; border: 2px solid var(--s);">
        <div class="scroll">
            <table>
                <thead>
                    <tr><th>C√≥d</th><th>Marca</th><th>Repuesto</th><th>Stock</th><th>Precio $</th><th>Precio Bs</th><th>Acci√≥n</th></tr>
                </thead>
                <tbody id="listaInv"></tbody>
            </table>
        </div>
    </div>

    <div class="panel panel-cli">
        <h3>üõí Punto de Venta</h3>
        <div class="form-group">
            <input type="text" id="c_cedula" placeholder="C√©dula del Cliente" onkeyup="buscarCliente(this.value)" class="full-w" style="border: 2px solid var(--a);">
            <input type="text" id="c_nombre" placeholder="Nombre Completo">
            <input type="text" id="c_telf" placeholder="Tel√©fono">
            <input type="text" id="c_moto" placeholder="Moto / Modelo" class="full-w">
        </div>
        <div id="ventaActiva" style="padding: 15px; background: #e0f2f1; margin: 10px; border-radius: 5px; display: none;">
            <p id="v_detalle"></p>
            <button onclick="confirmarVenta()" style="width: 100%; background: var(--s); color: white; padding: 15px;">IMPRIMIR FACTURA</button>
        </div>
        <h3 style="font-size: 14px;">üë• Clientes Registrados</h3>
        <div class="scroll" id="listaClientes"></div>
    </div>
</div>

<div id="ticketPrint" style="font-family: monospace; font-size: 12px;">
    <center>
        <strong>MOTO PRO REPUESTOS</strong><br>
        Factura de Venta<br>
        --------------------------
    </center>
    <p id="tf_cliente"></p>
    <p id="tf_moto"></p>
    <hr>
    <div id="tf_items"></div>
    <hr>
    <p id="tf_total_usd"></p>
    <p id="tf_total_bs"></p>
    <center>Tasa: <span id="tf_tasa"></span><br>¬°Gracias!</center>
</div>

<script>
    let inv = JSON.parse(localStorage.getItem('ultra_inv')) || [];
    let cli = JSON.parse(localStorage.getItem('ultra_cli')) || [];
    let ventaPendiente = null;

    function agregarProducto() {
        const id = "R" + Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
        const marca = document.getElementById('p_marca').value;
        const modelo = document.getElementById('p_modelo').value;
        const precio = document.getElementById('p_precio').value;
        const stock = document.getElementById('p_stock').value;

        if(!marca || !modelo || !precio) return alert("Datos incompletos");

        inv.push({ id, marca, modelo, precio: parseFloat(precio), stock: parseInt(stock) });
        save();
    }

    function buscarCliente(cedula) {
        const c = cli.find(item => item.cedula === cedula);
        if(c) {
            document.getElementById('c_nombre').value = c.nombre;
            document.getElementById('c_telf').value = c.telf;
            document.getElementById('c_moto').value = c.moto;
        }
    }

    function iniciarVenta(idx) {
        ventaPendiente = inv[idx];
        document.getElementById('ventaActiva').style.display = 'block';
        document.getElementById('v_detalle').innerHTML = `VENDIENDO: <b>${ventaPendiente.modelo}</b><br>Precio: $${ventaPendiente.precio}`;
    }

    function confirmarVenta() {
        const cedula = document.getElementById('c_cedula').value;
        const nombre = document.getElementById('c_nombre').value;
        const tasa = parseFloat(document.getElementById('tasa').value);

        if(!cedula || !nombre) return alert("Datos del cliente requeridos");

        // Guardar/Actualizar Cliente
        let c = cli.find(item => item.cedula === cedula);
        if(!c) {
            c = { cedula, nombre, telf: document.getElementById('c_telf').value, moto: document.getElementById('c_moto').value };
            cli.push(c);
        }

        // Procesar Stock
        ventaPendiente.stock--;

        // Llenar Ticket
        document.getElementById('tf_cliente').innerText = "CLIENTE: " + nombre + " (" + cedula + ")";
        document.getElementById('tf_moto').innerText = "MOTO: " + document.getElementById('c_moto').value;
        document.getElementById('tf_items').innerText = ventaPendiente.modelo + " - $" + ventaPendiente.precio;
        document.getElementById('tf_total_usd').innerText = "TOTAL USD: $" + ventaPendiente.precio;
        document.getElementById('tf_total_bs').innerText = "TOTAL BS: " + (ventaPendiente.precio * tasa).toFixed(2);
        document.getElementById('tf_tasa').innerText = tasa;

        save();
        window.print();
        document.getElementById('ventaActiva').style.display = 'none';
    }

    function render() {
        const q = document.getElementById('buscador').value.toLowerCase();
        const tasa = parseFloat(document.getElementById('tasa').value);
        const lInv = document.getElementById('listaInv');
        lInv.innerHTML = "";

        // Filtro r√°pido para alto rendimiento
        const filtrados = inv.filter(p => p.modelo.toLowerCase().includes(q) || p.marca.toLowerCase().includes(q) || p.id.includes(q));

        filtrados.slice(0, 100).forEach((p, i) => { // Mostramos de 100 en 100 para no trabar
            const precioBs = (p.precio * tasa).toFixed(2);
            lInv.innerHTML += `<tr>
                <td>${p.id}</td>
                <td>${p.marca}</td>
                <td>${p.modelo}</td>
                <td style="color:${p.stock < 5 ? 'red':'black'}"><b>${p.stock}</b></td>
                <td>$${p.precio}</td>
                <td>Bs ${precioBs}</td>
                <td><button onclick="iniciarVenta(${inv.indexOf(p)})" style="background:var(--s); color:white; padding:5px;">üõí</button></td>
            </tr>`;
        });

        const lCli = document.getElementById('listaClientes');
        lCli.innerHTML = cli.slice(-10).map(c => `<div style='font-size:11px; border-bottom:1px solid #eee; padding:5px;'>${c.nombre} (${c.cedula})</div>`).join("");
    }

    function save() {
        localStorage.setItem('ultra_inv', JSON.stringify(inv));
        localStorage.setItem('ultra_cli', JSON.stringify(cli));
        render();
    }

    render();
</script>
</body>
</html>

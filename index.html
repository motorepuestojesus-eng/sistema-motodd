<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA FRANQUICIA V11 - VELOCIDAD INTRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --success: #22c55e; --text: #f8fafc; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 240px; background: var(--card); border-right: 1px solid #334155; padding: 20px; }
        .nav-btn { width: 100%; padding: 12px; margin-bottom: 8px; background: none; border: none; color: #94a3b8; text-align: left; cursor: pointer; border-radius: 8px; }
        .nav-btn.active { background: var(--accent); color: #000; font-weight: bold; }
        .main { flex: 1; padding: 25px; overflow-y: auto; }
        .page { display: none; } .page.active { display: block; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #334155; margin-bottom: 15px; }
        input, select { width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 8px; font-size: 1rem; }
        .search-res { position: absolute; width: 100%; background: #2d3748; border: 1px solid var(--accent); z-index: 99; border-radius: 8px; display: none; margin-top: 2px; }
        .res-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #334155; }
        .res-item.selected { background: var(--accent); color: #000; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 10px; border-bottom: 1px solid #334155; color: #94a3b8; }
        td { padding: 10px; border-bottom: 1px solid #334155; }
        .total-panel { text-align: center; border-top: 2px solid var(--accent); padding-top: 15px; }
        .total-usd { font-size: 3rem; color: var(--accent); font-weight: 800; }
        .total-bs { font-size: 1.5rem; color: var(--success); display: none; }
        .kb-hint { font-size: 0.7rem; color: var(--accent); margin-top: 4px; display: block; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2 style="color:var(--accent); margin-bottom: 20px;">POS RAPID</h2>
        <button class="nav-btn active" onclick="tab('pos')">CAJA (F2)</button>
        <button class="nav-btn" onclick="tab('cli')">CLIENTES</button>
        <button class="nav-btn" onclick="tab('inv')">STOCK</button>
        <button class="nav-btn" onclick="tab('rep')">REPORTES</button>
    </div>

    <main class="main">
        <div id="tab-pos" class="page active">
            <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 15px;">
                <div style="flex: 1;">
                    <label>Tasa BCV del Día:</label>
                    <input type="number" id="tasa" value="36.50" onchange="calc()">
                </div>
                <div style="flex: 2; padding: 15px; background: #334155; border-radius: 8px;">
                    <small>Atajos: <b>INTRO</b> para seleccionar/añadir | <b>F10</b> para Cobrar</small>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 400px; gap: 20px;">
                <div class="card">
                    <h3>Buscador de Productos</h3>
                    <div style="position:relative;">
                        <input type="text" id="p-search" placeholder="Escribe nombre o marca..." autocomplete="off">
                        <span class="kb-hint">Presiona INTRO para agregar el primero</span>
                        <div id="p-list" class="search-res"></div>
                    </div>
                    <table>
                        <thead><tr><th>Item</th><th>Cant</th><th>Precio</th><th>Total</th></tr></thead>
                        <tbody id="cart"></tbody>
                    </table>
                </div>

                <div class="card">
                    <h3>Cliente</h3>
                    <div style="position:relative;">
                        <input type="text" id="c-search" placeholder="Cédula..." autocomplete="off">
                        <span class="kb-hint">Presiona INTRO para seleccionar</span>
                        <div id="c-list" class="search-res"></div>
                    </div>
                    <div id="c-info" style="margin: 10px 0; color: var(--accent); font-weight: bold; min-height: 20px;"></div>

                    <h3>Método de Pago</h3>
                    <select id="pay" onchange="calc()">
                        <option value="USD">Divisas ($)</option>
                        <option value="BS">Bolívares (Efectivo/Punto)</option>
                    </select>

                    <div class="total-panel">
                        <div class="total-usd" id="t-usd">$0.00</div>
                        <div class="total-bs" id="t-bs">0.00 Bs.</div>
                        <button class="nav-btn active" style="margin-top:20px; text-align:center;" onclick="cobrar()">FINALIZAR VENTA (F10)</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-cli" class="page">
            <div class="card">
                <h2>Nuevo Cliente</h2>
                <input type="text" id="rc" placeholder="Cédula">
                <input type="text" id="rn" placeholder="Nombre">
                <button class="nav-btn active" onclick="saveC()">Guardar</button>
            </div>
        </div>
        <div id="tab-inv" class="page">
            <div class="card">
                <h2>Cargar Stock</h2>
                <input type="text" id="in" placeholder="Nombre">
                <input type="text" id="im" placeholder="Marca">
                <input type="number" id="ip" placeholder="Precio $">
                <button class="nav-btn active" onclick="saveI()">Cargar</button>
            </div>
        </div>
        <div id="tab-rep" class="page">
            <button class="nav-btn active" style="width:auto" onclick="excel()">Descargar Excel</button>
            <div class="card">
                <table id="rep-table"><thead><tr><th>Fecha</th><th>Cliente</th><th>Monto $</th><th>Monto Bs</th></tr></thead><tbody id="rep-data"></tbody></table>
            </div>
        </div>
    </main>

    <script>
        let db = {
            cli: JSON.parse(localStorage.getItem('v11_c')) || [],
            pro: JSON.parse(localStorage.getItem('v11_p')) || [],
            ven: JSON.parse(localStorage.getItem('v11_v')) || [],
            cart: [], cliAct: null, sum: 0
        };

        function tab(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            if(id==='rep') renderRep();
        }

        // --- BUSCADOR INTELIGENTE PRODUCTOS + INTRO ---
        const pInput = document.getElementById('p-search');
        pInput.onkeyup = (e) => {
            const val = pInput.value.toLowerCase();
            const res = document.getElementById('p-list');
            if(!val) { res.style.display='none'; return; }

            const matches = db.pro.filter(x => x.nom.toLowerCase().includes(val) || x.mar.toLowerCase().includes(val));
            
            if(e.key === 'Enter' && matches.length > 0) {
                addItem(matches[0].id);
                pInput.value = '';
                res.style.display = 'none';
                return;
            }

            res.innerHTML = matches.map(p => `<div class="res-item" onclick="addItem(${p.id})">${p.nom} (${p.mar}) - $${p.pre}</div>`).join('');
            res.style.display = matches.length ? 'block' : 'none';
        };

        // --- BUSCADOR INTELIGENTE CÉDULA + INTRO ---
        const cInput = document.getElementById('c-search');
        cInput.onkeyup = (e) => {
            const val = cInput.value;
            const res = document.getElementById('c-list');
            if(!val) { res.style.display='none'; return; }

            const matches = db.cli.filter(x => x.ced.includes(val));

            if(e.key === 'Enter' && matches.length > 0) {
                setCli(matches[0].ced);
                res.style.display = 'none';
                pInput.focus(); // Salta al buscador de productos
                return;
            }

            res.innerHTML = matches.map(c => `<div class="res-item" onclick="setCli('${c.ced}')">${c.ced} - ${c.nom}</div>`).join('');
            res.style.display = matches.length ? 'block' : 'none';
        };

        function addItem(id) {
            const p = db.pro.find(x => x.id === id);
            const ex = db.cart.find(x => x.id === id);
            if(ex) ex.cant++; else db.cart.push({...p, cant: 1});
            renderCart();
            pInput.focus();
        }

        function setCli(ced) {
            db.cliAct = db.cli.find(x => x.ced === ced);
            document.getElementById('c-search').value = ced;
            document.getElementById('c-info').innerText = "Cliente: " + db.cliAct.nom;
        }

        function renderCart() {
            const b = document.getElementById('cart');
            b.innerHTML = ''; db.sum = 0;
            db.cart.forEach(i => {
                const sub = i.pre * i.cant; db.sum += sub;
                b.innerHTML += `<tr><td>${i.nom}</td><td>${i.cant}</td><td>$${i.pre}</td><td>$${sub.toFixed(2)}</td></tr>`;
            });
            calc();
        }

        function calc() {
            const t = parseFloat(document.getElementById('tasa').value);
            document.getElementById('t-usd').innerText = `$${db.sum.toFixed(2)}`;
            const bBox = document.getElementById('t-bs');
            if(document.getElementById('pay').value === 'BS') {
                bBox.innerText = (db.sum * t).toFixed(2) + " Bs.";
                bBox.style.display = 'block';
            } else bBox.style.display = 'none';
        }

        function cobrar() {
            if(!db.cliAct || db.sum === 0) return alert("Error: Cliente o Carrito vacío");
            const t = parseFloat(document.getElementById('tasa').value);
            db.ven.push({
                f: new Date().toLocaleString(),
                c: db.cliAct.nom,
                u: db.sum.toFixed(2),
                b: (db.sum * t).toFixed(2)
            });
            localStorage.setItem('v11_v', JSON.stringify(db.ven));
            alert("VENTA EXITOSA");
            location.reload();
        }

        // --- FUNCIONES EXTRA ---
        function saveC() { db.cli.push({ced: document.getElementById('rc').value, nom: document.getElementById('rn').value}); localStorage.setItem('v11_c', JSON.stringify(db.cli)); alert("OK"); }
        function saveI() { db.pro.push({id: Date.now(), nom: document.getElementById('in').value, mar: document.getElementById('im').value, pre: parseFloat(document.getElementById('ip').value)}); localStorage.setItem('v11_p', JSON.stringify(db.pro)); alert("OK"); }
        function renderRep() { document.getElementById('rep-data').innerHTML = db.ven.map(v => `<tr><td>${v.f}</td><td>${v.c}</td><td>$${v.u}</td><td>${v.b} Bs</td></tr>`).join(''); }
        function excel() {
            let csv = "Fecha,Cliente,USD,BS\n" + db.ven.map(v => `${v.f},${v.c},${v.u},${v.b}`).join("\n");
            const blob = new Blob([csv], {type: 'text/csv'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ventas.csv'; a.click();
        }
    </script>
</body>
</html>

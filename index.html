<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP MotoPro - Gesti√≥n Integral</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        :root { --p: #1a237e; --s: #0288d1; --a: #ff6f00; --bg: #f5f7fa; --text: #333; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; color: var(--text); display: flex; flex-direction: column; height: 100vh; }
        
        /* Dashboard Header */
        header { background: var(--p); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .nav-tabs { display: flex; background: #fff; padding: 10px; gap: 10px; border-bottom: 2px solid #ddd; }
        .tab-btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; background: #eee; font-weight: bold; transition: 0.3s; }
        .tab-btn.active { background: var(--s); color: white; }

        .content { flex: 1; padding: 20px; overflow-y: auto; display: none; }
        .content.active { display: block; }

        /* CRM & Ventas */
        .grid-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        /* Inventario Masivo */
        .search-box { width: 100%; padding: 12px; border: 2px solid var(--s); border-radius: 25px; margin-bottom: 15px; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 14px; }
        th { background: #f1f1f1; padding: 12px; text-align: left; position: sticky; top: 0; }
        td { padding: 10px; border-bottom: 1px solid #eee; }

        /* Finanzas */
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { padding: 20px; border-radius: 8px; color: white; text-align: center; }
        
        .btn-vender { background: #27ae60; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; }
        
        @media print {
            body * { visibility: hidden; }
            #ticket, #ticket * { visibility: visible; display: block !important; position: absolute; left: 0; top: 0; width: 58mm; }
        }
    </style>
</head>
<body>

<header>
    <div><strong>MOTO PRO ERP v3.0</strong> | Tasa: <input type="number" id="globalTasa" value="36.50" step="0.1" style="width:60px; background:none; color:white; border:1px solid #fff; border-radius:3px;"> Bs/$</div>
    <div id="reloj"></div>
</header>

<div class="nav-tabs">
    <button class="tab-btn active" onclick="openTab(event, 'tab-ventas')">üõí Ventas (POS)</button>
    <button class="tab-btn" onclick="openTab(event, 'tab-inventario')">üì¶ Inventario</button>
    <button class="tab-btn" onclick="openTab(event, 'tab-crm')">üë• CRM / Clientes</button>
    <button class="tab-btn" onclick="openTab(event, 'tab-finanzas')">üí∞ Finanzas</button>
</div>

<div id="tab-ventas" class="content active">
    <div class="grid-layout">
        <div class="card">
            <input type="text" id="posSearch" class="search-box" placeholder="Escanear C√≥digo o Buscar Repuesto..." onkeyup="buscarPOS()">
            <div style="max-height: 500px; overflow-y: auto;">
                <table id="posTable">
                    <thead><tr><th>Repuesto</th><th>Marca</th><th>Stock</th><th>Precio</th><th>Acci√≥n</th></tr></thead>
                    <tbody id="posBody"></tbody>
                </table>
            </div>
        </div>
        <div class="card">
            <h3>Datos del Cliente</h3>
            <input type="text" id="vC√©dula" placeholder="C√©dula" onblur="autocompletarCliente(this.value)" style="width:100%; padding:8px; margin-bottom:10px;">
            <input type="text" id="vNombre" placeholder="Nombre" style="width:100%; padding:8px; margin-bottom:10px;">
            <input type="text" id="vMoto" placeholder="Moto / Modelo" style="width:100%; padding:8px; margin-bottom:10px;">
            <div id="listaCompra" style="border-top:1px solid #ddd; margin-top:10px; padding-top:10px;">
                <strong>Item:</strong> <span id="itemName">Ninguno</span><br>
                <strong>Total:</strong> <span id="itemTotal">$0.00</span>
            </div>
            <button onclick="finalizarVenta()" style="width:100%; background:var(--p); color:white; padding:15px; margin-top:20px; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">FACTURAR E IMPRIMIR</button>
        </div>
    </div>
</div>

<div id="tab-inventario" class="content">
    <div class="card">
        <h3>Carga Masiva y Control de Stock</h3>
        <div style="background:#f9f9f9; padding:15px; border-radius:5px; margin-bottom:20px;">
            <input type="text" id="iMarca" placeholder="Marca">
            <input type="text" id="iModelo" placeholder="Modelo">
            <input type="number" id="iPrecio" placeholder="Precio $">
            <input type="number" id="iStock" placeholder="Stock Inicial">
            <button onclick="guardarNuevo()">Registrar</button>
        </div>
        <table id="invTable">
            <thead><tr><th>C√≥digo</th><th>Marca</th><th>Modelo</th><th>Stock</th><th>USD</th><th>Acciones</th></tr></thead>
            <tbody id="invBody"></tbody>
        </table>
    </div>
</div>

<div id="tab-crm" class="content">
    <div class="card">
        <h3>Historial de Clientes Potenciales y Post-Venta</h3>
        <table id="crmTable">
            <thead><tr><th>C√©dula</th><th>Nombre</th><th>Moto</th><th>√öltima Compra</th><th>Estatus</th></tr></thead>
            <tbody id="crmBody"></tbody>
        </table>
    </div>
</div>

<div id="tab-finanzas" class="content">
    <div class="stat-grid">
        <div class="stat-card" style="background: #2ecc71;">Ventas del D√≠a<br><h2 id="fVentasDia">$0.00</h2></div>
        <div class="stat-card" style="background: #3498db;">Efectivo en Bs<br><h2 id="fEfectivoBs">Bs 0.00</h2></div>
        <div class="stat-card" style="background: #f1c40f;">Productos Vendidos<br><h2 id="fItemsVendidos">0</h2></div>
    </div>
    <div class="card">
        <h3>Reporte de Transacciones</h3>
        <table id="reporteTable">
            <thead><tr><th>Fecha</th><th>Cliente</th><th>Total $</th><th>Total Bs</th></tr></thead>
            <tbody id="reporteBody"></tbody>
        </table>
    </div>
</div>

<div id="ticket" style="font-family: monospace; font-size: 12px; width: 58mm;">
    <center><strong>MOTOPRO REPUESTOS</strong><br>RIF: J-50000000-0</center>
    <hr>
    <div id="tContent"></div>
    <hr>
    <div id="tTotal"></div>
</div>

<script>
    let productos = JSON.parse(localStorage.getItem('mp_prod')) || [];
    let clientes = JSON.parse(localStorage.getItem('mp_cli')) || [];
    let ventas = JSON.parse(localStorage.getItem('mp_ventas')) || [];
    let itemActual = null;

    function openTab(evt, tabName) {
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.classList.add('active');
        render();
    }

    function guardarNuevo() {
        const id = "M" + Date.now().toString().slice(-6);
        productos.push({
            id,
            marca: document.getElementById('iMarca').value,
            modelo: document.getElementById('iModelo').value,
            precio: parseFloat(document.getElementById('iPrecio').value),
            stock: parseInt(document.getElementById('iStock').value)
        });
        save();
    }

    function autocompletarCliente(cedula) {
        const c = clientes.find(x => x.cedula === cedula);
        if(c) {
            document.getElementById('vNombre').value = c.nombre;
            document.getElementById('vMoto').value = c.moto;
        }
    }

    function buscarPOS() {
        const q = document.getElementById('posSearch').value.toLowerCase();
        const res = productos.filter(p => p.modelo.toLowerCase().includes(q) || p.id.toLowerCase().includes(q));
        const body = document.getElementById('posBody');
        body.innerHTML = res.slice(0,10).map(p => `
            <tr>
                <td>${p.modelo}</td><td>${p.marca}</td><td>${p.stock}</td><td>$${p.precio}</td>
                <td><button class="btn-vender" onclick="seleccionarItem('${p.id}')">üõí</button></td>
            </tr>
        `).join('');
    }

    function seleccionarItem(id) {
        itemActual = productos.find(p => p.id === id);
        document.getElementById('itemName').innerText = itemActual.modelo;
        document.getElementById('itemTotal').innerText = "$" + itemActual.precio;
    }

    function finalizarVenta() {
        if(!itemActual) return alert("Selecciona un producto");
        const cedula = document.getElementById('vC√©dula').value;
        const nombre = document.getElementById('vNombre').value;
        const tasa = parseFloat(document.getElementById('globalTasa').value);

        if(!cedula || !nombre) return alert("Datos de cliente incompletos");

        // CRM: Registrar o actualizar cliente
        let c = clientes.find(x => x.cedula === cedula);
        if(!c) {
            c = { cedula, nombre, moto: document.getElementById('vMoto').value, compras: 0 };
            clientes.push(c);
        }
        c.compras++;

        // Finanzas & Stock
        itemActual.stock--;
        const totalBs = (itemActual.precio * tasa).toFixed(2);
        ventas.push({ fecha: new Date().toLocaleDateString(), cliente: nombre, total: itemActual.precio, totalBs });

        // Imprimir Ticket
        document.getElementById('tContent').innerHTML = `
            Fecha: ${new Date().toLocaleString()}<br>
            Cliente: ${nombre}<br>
            Item: ${itemActual.modelo}
        `;
        document.getElementById('tTotal').innerHTML = `
            Total USD: $${itemActual.precio}<br>
            Total Bs: ${totalBs}<br>
            Tasa: ${tasa}
        `;

        save();
        window.print();
        itemActual = null;
    }

    function save() {
        localStorage.setItem('mp_prod', JSON.stringify(productos));
        localStorage.setItem('mp_cli', JSON.stringify(clientes));
        localStorage.setItem('mp_ventas', JSON.stringify(ventas));
        render();
    }

    function render() {
        // Renderizar Tablas
        document.getElementById('invBody').innerHTML = productos.slice(-50).map(p => `
            <tr><td>${p.id}</td><td>${p.marca}</td><td>${p.modelo}</td><td>${p.stock}</td><td>$${p.precio}</td><td><button onclick="imprimirCod('${p.id}')">üñ®Ô∏è</button></td></tr>
        `).join('');

        document.getElementById('crmBody').innerHTML = clientes.map(c => `
            <tr><td>${c.cedula}</td><td>${c.nombre}</td><td>${c.moto}</td><td>Hoy</td><td>Recurrente</td></tr>
        `).join('');

        // Reporte Financiero
        const totalDia = ventas.reduce((a, b) => a + b.total, 0);
        const totalBs = ventas.reduce((a, b) => a + parseFloat(b.totalBs), 0);
        document.getElementById('fVentasDia').innerText = "$" + totalDia.toFixed(2);
        document.getElementById('fEfectivoBs').innerText = "Bs " + totalBs.toFixed(2);
        document.getElementById('fItemsVendidos').innerText = ventas.length;
    }

    function imprimirCod(id) {
        alert("Generando c√≥digo de barras para: " + id);
        // Aqu√≠ podr√≠as reutilizar la l√≥gica de etiquetas ya creada.
    }

    render();
    setInterval(() => document.getElementById('reloj').innerText = new Date().toLocaleString(), 1000);
</script>
</body>
</html>
